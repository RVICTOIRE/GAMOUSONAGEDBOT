<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Administration - Signalements</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { margin-bottom: 8px; }
  .controls { margin-bottom: 16px; }
  .hint { color: #666; font-size: 0.92em; margin-bottom: 12px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px; }
  th { background: #f5f5f5; text-align: left; }
  tr:nth-child(even) { background: #fafafa; }
  input[type="text"] { width: 320px; padding: 6px; }
  button { padding: 6px 10px; cursor: pointer; }
  .muted { color: #999; }
  .delete-btn { background: #ff4444; color: white; border: none; }
  .delete-btn:hover { background: #cc0000; }
  .delete-criteria-btn { background: #ff8800; color: white; border: none; }
  .delete-criteria-btn:hover { background: #cc6600; }
</style>
</head>
<body>
  <h1>Administration - Signalements</h1>
  <div class="controls">
    <label>Clé admin: <input id="token" type="text" placeholder="Coller ADMIN_TOKEN ici" /></label>
    <button onclick="loadData()">Rafraîchir</button>
  </div>
  <div class="hint">
    Cette page lit le <strong>fichier JSON</strong> comme la carte et le tableau de bord. 
    <br>• <strong>Suppression par ID</strong> : Pour les entrées avec ID en base (bouton rouge)
    <br>• <strong>Suppression par critères</strong> : Pour toutes les entrées (bouton orange)
  </div>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Date/Heure</th>
        <th>Utilisateur</th>
        <th>Type</th>
        <th>Message</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="8">Chargement…</td></tr>
    </tbody>
  </table>
  <script>
    async function loadData() {
      const token = document.getElementById('token').value.trim();
      const res = await fetch(`/api/admin/signalements?token=${encodeURIComponent(token)}`);
      const tbody = document.getElementById('rows');
      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="8">Erreur ${res.status} - vérifiez la clé admin</td></tr>`;
        return;
      }
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">Aucun signalement</td></tr>';
        return;
      }
      tbody.innerHTML = data.map((item, index) => {
        const id = item.id;
        const date = item['Date/Heure'] || '';
        const user = item['Utilisateur'] || '';
        const type = item['Type'] || '';
        const msg = item['Message'] || '';
        const lat = item['Latitude'] ?? '';
        const lng = item['Longitude'] ?? '';
        
        // Bouton de suppression par ID (si disponible)
        const deleteByIdBtn = id 
          ? `<button class="delete-btn" onclick="delById(${id})">Supprimer par ID</button>`
          : '';
        
        // Bouton de suppression par critères (toujours disponible)
        const deleteByCriteriaBtn = `<button class="delete-criteria-btn" onclick="delByCriteria('${escapeHtml(date)}', '${escapeHtml(user)}', '${escapeHtml(type)}', '${escapeHtml(msg)}')">Supprimer par critères</button>`;
        
        const actionCell = deleteByIdBtn 
          ? `${deleteByIdBtn}<br>${deleteByCriteriaBtn}`
          : deleteByCriteriaBtn;
        
        return `<tr>
          <td>${id ?? '<span class="muted">Pas d\'ID</span>'}</td>
          <td>${escapeHtml(date)}</td>
          <td>${escapeHtml(user)}</td>
          <td>${escapeHtml(type)}</td>
          <td>${escapeHtml(msg)}</td>
          <td>${lat}</td>
          <td>${lng}</td>
          <td>${actionCell}</td>
        </tr>`;
      }).join('');
    }

    async function delById(id) {
      const token = document.getElementById('token').value.trim();
      if (!confirm(`Supprimer le signalement avec ID ${id} ?`)) return;
      
      try {
        const res = await fetch(`/api/signalements/${id}?token=${encodeURIComponent(token)}`, { method: 'DELETE' });
        if (!res.ok) {
          const error = await res.json();
          alert(`Suppression échouée: ${error.message || 'Erreur inconnue'}`);
          return;
        }
        const result = await res.json();
        alert(`✅ ${result.message}`);
        await loadData();
      } catch (error) {
        alert(`Erreur: ${error.message}`);
      }
    }

    async function delByCriteria(date, user, type, message) {
      const token = document.getElementById('token').value.trim();
      
      // Construire le message de confirmation
      const criteria = [];
      if (date) criteria.push(`Date: ${date}`);
      if (user) criteria.push(`Utilisateur: ${user}`);
      if (type) criteria.push(`Type: ${type}`);
      if (message) criteria.push(`Message: ${message}`);
      
      if (!confirm(`Supprimer le signalement avec ces critères ?\n\n${criteria.join('\n')}`)) return;
      
      try {
        const payload = {};
        if (date) payload.date_heure = date;
        if (user) payload.utilisateur = user;
        if (type) payload.type = type;
        if (message) payload.message = message;
        
        const res = await fetch(`/api/signalements/delete?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          const error = await res.json();
          alert(`Suppression échouée: ${error.message || 'Erreur inconnue'}`);
          return;
        }
        
        const result = await res.json();
        alert(`✅ ${result.message}`);
        await loadData();
      } catch (error) {
        alert(`Erreur: ${error.message}`);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    loadData();
  </script>
</body>
</html>
