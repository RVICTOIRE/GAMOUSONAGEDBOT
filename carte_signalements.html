<!DOCTYPE html>
<html>
<head>
    <title>Carte des signalements</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        header { padding: 12px 16px; background: #2b6cb0; color: #fff; }
        header h2 { margin: 0; font-size: 18px; }
        .toolbar { padding: 8px 16px; display: flex; gap: 10px; align-items: center; }
        .toolbar a { text-decoration: none; color: #2b6cb0; font-weight: 600; }
        .muted { color: #64748b; font-size: 12px; }
        #map { height: calc(100vh - 92px); }
    </style>
</head>
<body>
    <header>
        <h2>Signalements SONAGED - Gamou Medina Baye</h2>
    </header>
    <div class="toolbar">
        <!-- <a href="/form">Envoyer un signalement</a> -->
        <span class="muted">|</span>
        <a href="/dashboard">Voir le tableau de bord</a>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialisation de la carte (position provisoire)
        var map = L.map('map').setView([14.1445, -16.0726], 13);

        // Fond de carte
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Ic√¥nes color√©es
        var redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var blueIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Fonction pour charger les signalements
        function loadSignalements() {
            // Nettoyer les marqueurs existants
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            fetch('/signalements.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Chargement de ${data.length} signalements`);
                var markers = [];

                data.forEach(item => {
                    if (item.Latitude && item.Longitude) {
                        let iconChoisi = blueIcon;
                        if (item.Type === "üóë Bac plein") iconChoisi = redIcon;
                        else if (item.Type === "üìç D√©p√¥t") iconChoisi = greenIcon;

                        var marker = L.marker([item.Latitude, item.Longitude], { icon: iconChoisi })
                            .bindPopup(`<b>${item.Type}</b><br>${item.Message}<br><small>${item.Utilisateur}</small>`)
                            .addTo(map);

                        markers.push(marker);
                    }
                });

                // Adapter la vue √† tous les marqueurs
                if (markers.length > 0) {
                    var group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds(), { padding: [50, 50] });
                } else {
                    console.log("Aucun signalement avec coordonn√©es valides trouv√©");
                }
            })
            .catch(err => {
                console.error("Erreur de chargement des signalements :", err);
                alert("Erreur de chargement des signalements. V√©rifiez la console pour plus de d√©tails.");
            });
        }

        // Charger les signalements au d√©marrage
        loadSignalements();

        // Ajouter un bouton de rafra√Æchissement
        var refreshButton = L.control({position: 'topright'});
        refreshButton.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<button onclick="loadSignalements()" style="padding: 8px 12px; background: #2b6cb0; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Rafra√Æchir</button>';
            return div;
        };
        refreshButton.addTo(map);
    </script>
</body>
</html>
